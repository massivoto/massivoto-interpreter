# Brainstorm: @ai/image/generate

**Date:** 2026-02-23
**Participants:** User + Claude

---

## Architecture Decision: `@ai/image/*` vs `@ai/prompt/*` families

**Options considered:**
- Option A: Group by media type — `@ai/image/generate`, `@ai/image/reversePrompt`
- Option B: Group by output type — `@ai/image/generate` (returns image), `@ai/prompt/reverseImage` (returns text)

**Decision:** Option B — group by output type.

**Rationale:**
- The `@ai/prompt/*` family grows naturally (merge, refine, etc.) — they're all prompt-engineering tools
- Clear contract: `@ai/image/*` always returns image data, `@ai/prompt/*` always returns text
- `@ai/image/reversePrompt` would be misleading — you go there expecting image output but get text

**Naming:**
- `@ai/image/generate` replaces the old `@ai/image`
- `@ai/prompt/reverseImage` stays as-is
- Future siblings: `@ai/image/edit`, `@ai/image/upscale`, `@ai/prompt/merge`, `@ai/prompt/refine`

---

## 1. Product Role

**What it IS:**
- The image generation command in the `@ai/image/*` family
- Takes a prompt (possibly a template with `{{variation}}`) and produces an image
- Replacement for the old `@ai/image` handler
- The second step in the content pipeline: `reversePrompt -> generate -> human/validation -> file/save`

**What it is NOT:**
- Not a prompt engineering tool (that's `@ai/prompt/*`)
- Not an image editing/upscaling tool (future `@ai/image/edit`)
- Not responsible for `{{variation}}` template syntax — it just does string replacement as a convenience

**Decision:** `@ai/image/generate` is a thin command. It does one thing: send a prompt to a provider and return an image.

---

## 2. Target Audience

**Decision:** General-purpose — any workflow author who needs to generate images from prompts. Not theme-specific.

---

## 3. Core Problem

**Problem:** You have a prompt (possibly generated by `@ai/prompt/reverseImage` with a `{{variation}}` placeholder) and you need to turn it into an image.

**Decision:** The command handles `{{variation}}` substitution as a convenience. Single variable only — multi-variable substitution belongs in `@ai/prompt/merge`.

**Rationale:** The `forEach=situations->situation` + `variation=situation` pattern is THE primary use case. Deserves first-class support. A `replace` pipe would be technically cleaner but worse DX.

---

## 4. Unique Value Proposition

OTO integration: `variation` substitution + `forEach` + `collect` in a one-liner. No special differentiator beyond that.

---

## 5. Acquisition Strategy

Internal command. Discovered through docs and registry.

---

## 6. Functional Scope

**IN scope:**
- `prompt` — required, text prompt or template (may contain `{{variation}}`)
- `variation` — optional, string value to substitute into `{{variation}}` via `replaceAll`
- `model` — optional, free string: "light", "best", or raw model ID. Default: "best"
- `size` — optional: "square", "landscape", "portrait". Default: "square". Kept as optional param but not advertised — prompt carries the intent
- `style` — optional: "photo", "illustration", "3d". Kept as optional param — prompt carries the intent
- Returns base64-encoded image data as output value

**OUT of scope:**
- Multiple `{{variable}}` substitutions (use `@ai/prompt/merge`)
- Image editing / inpainting (future `@ai/image/edit`)
- Output format selection (png vs jpg)
- Saving to file (that's `@file/save`)
- Cost tracking (deferred to v1)
- Provider arg — `model` handles provider resolution
- Value resolver / type coercion (deferred to v0.9 — see roadmap note below)

**Decision on defaults:** Default values for `size`, `style`, `model` live in a shared `ai/defaults.ts` constants file. Single source of truth across all `@ai/image/*` commands. No duplication between commands.

```typescript
// ai/defaults.ts
export const AI_IMAGE_DEFAULTS = {
  size: 'square' as const,
  style: undefined,  // no default style — provider's choice
  model: 'best',
}
```

---

## 7. Core Features

### Feature: Image generation from prompt

**Capability:** Takes a text prompt, sends it to the AI provider (Gemini/Nano Banana), returns a base64-encoded image.

**Acceptance Criteria:**
- Given a valid prompt string, When `@ai/image/generate prompt="A racing car" output=img` is executed, Then `img` contains a non-empty base64 string
- Given `model="light"`, When the command runs, Then it uses the cheaper/faster model
- Given `model="best"` or no model arg, When the command runs, Then it uses the highest quality model
- Given the AI provider returns an error (rate limit, invalid key), When the command runs, Then it returns a failed ActionResult with a clear error message

**Test Approach:** Unit test with mock provider. Integration test against real Gemini API (manual/CI with API key).

---

### Feature: `{{variation}}` substitution

**Capability:** If `variation` arg is provided and prompt contains `{{variation}}`, all occurrences are replaced via `replaceAll` before sending to the provider.

**Acceptance Criteria:**
- Given `prompt="A car {{variation}}"` and `variation="under the rain"`, When the command runs, Then the prompt sent to the provider is `"A car under the rain"`
- Given `variation` is provided but prompt has no `{{variation}}` placeholder, When the command runs, Then the prompt is sent as-is (no error, no-op)
- Given no `variation` arg, When the command runs, Then `{{variation}}` stays as literal text in the prompt (harmless)
- Given prompt contains `{{variation}}` twice, When `variation="rain"` is provided, Then both occurrences are replaced

**Test Approach:** Unit test asserting the string sent to the mock provider after substitution.

---

### Feature: Model tier resolution

**Capability:** `model` is a free string. "light" and "best" are aliases resolved per provider. Unknown strings are passed as raw model IDs.

**Acceptance Criteria:**
- Given `model="best"`, When using Gemini provider, Then it resolves to the appropriate Gemini model ID
- Given `model="gemini-2.0-flash"`, When the command runs, Then it passes that exact string to the provider
- Given a provider with only one image model, When either tier is selected, Then both resolve to the same model

**Test Approach:** Unit test asserting model ID resolution.

---

## 8. Differentiating Features

No separate differentiating features. The differentiator IS the OTO integration: `variation` + `forEach` + `collect` in a one-liner.

---

## 9. Version Assignment

**Decision:** Ship everything at once as POC.

| Feature | Version | Rationale |
|---------|---------|-----------|
| Image generation from prompt | POC | Core value, must work |
| `{{variation}}` substitution | POC | One `replaceAll` call, zero cost |
| Model tier resolution | POC | Same pattern as reverseImage |

---

## 10. Critical Edge Cases

| Edge Case | Expected Behavior |
|-----------|-------------------|
| Prompt is empty or missing | Fail with clear error: "Prompt is required" |
| `variation` provided but no `{{variation}}` in prompt | No-op, prompt sent as-is. No warning |
| No `variation` arg, prompt contains `{{variation}}` | Sent as literal text. Harmless |
| `{{variation}}` appears multiple times | `replaceAll` — all occurrences replaced |
| Provider returns empty/corrupt base64 | Return as-is. Downstream shows broken image — user decides |
| Very long prompt | Pass to provider. Let the API reject if over token limit |
| `variation` contains special characters, quotes, newlines | Substitute as-is. No escaping. It's text going into text |
| Provider API key missing | Fail with clear error pointing to env setup |
| `model` string doesn't match any known tier | Pass as raw string to provider. Let the API reject |

**Decision:** No validation on our side. Trust the provider for image quality, trust the prompt for correctness. Standard error handling through ActionResult.

---

## 11. Non-Functional Constraints

- **Performance:** Single API call to image generation model. Slow by nature (2-15s). Nothing to optimize. forEach parallelism is a runtime concern.
- **Security:** Prompt goes to third-party API. Same trust model as all `@ai/*` commands. Future value resolver will add sanitization.
- **Cost:** Image generation is expensive. With `forEach` over 10 situations + `retry=3`, up to 30 API calls. No tracking for now (deferred to v1).

---

## 12. External Dependencies

| Dependency | Status | Risk |
|------------|--------|------|
| Gemini image generation API | Available. `GeminiProvider.generateImage()` exists | None |
| `AiProvider` interface | Has `generateImage(request: ImageRequest)` | Low — `ImageRequest` keeps `size`/`style` as optional |
| Model tier mapping | Exists in reverseImage pattern | None — reuse same approach |
| `forEach` + `collect` reserved args | Under heavy work on separate instance | None — command doesn't need to know about them |
| `retry` reserved arg | Under heavy work on separate instance | None — interpreter handles retry |

**Decision on `ImageRequest`:** Keep `size` and `style` on the interface as optional fields. The command doesn't expose them prominently but they stay ready for future `@ai/image/edit` or when the command learns to extract them from the prompt with AI.

---

## 13. Major Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| Image quality is poor | Users reject all images in gallery | Iterate on model selection. Not a command problem — provider/model problem |
| `{{variation}}` substitution produces bad prompts | Generated image doesn't reflect variation | Prompt engineering problem. reverseImage system prompt must place `{{variation}}` semantically |
| Cost explosion with forEach + retry | Unexpected API bills | v1 cost tracking + cost limits. For now, user responsibility |
| Gemini rate limiting under forEach | Parallel calls hit limits | Runtime concern — forEach execution strategy is interpreter's decision |

**Decision:** No blockers. Command is thin. Most risks are in surrounding infrastructure.

---

## 14. Priority

**High priority.** Second line of the v0.6 OTO program. March 6th deadline for The Race Was Great.

```oto
@ai/prompt/reverseImage image=~/f1.png output=f1RacingPrompt
@ai/image/generate prompt=f1RacingPrompt variation=situation forEach=situations->situation retry=3 collect=images
@human/validation items=images display=gallery output=selectedImages
@file/save file=~/selection/f1.png forEach=selectedImages->image
```

Without this command, the pipeline stops at step 1.

**Dependencies satisfied:**
- `@ai/prompt/reverseImage` — done
- `GeminiProvider.generateImage()` — done
- `forEach`, `collect`, `retry` — under work on separate instance, not blocking this command

---

## Roadmap Note: Value Resolver (v0.9)

Captured during this brainstorm: the need for a value resolver layer between evaluator and command handlers. See ROADMAP.md for full description.

**Context:** The decision to return raw base64 (not a structured ImageObject) was driven by the fact that downstream commands would need to handle multiple input types. A value resolver would normalize inputs before they reach handlers, providing type coercion and input sanitization as a central chokepoint.

**Trigger:** Build when the 3rd command hits the "I don't know what type this input is" problem.

---

## Gaps / Open Questions

1. **Model IDs for Gemini image generation:** What are the concrete model IDs for "light" and "best" tiers? Need to verify against current Gemini API.
2. **`ai/defaults.ts` location:** Should this live at `core-handlers/ai/defaults.ts` or in the shared `@massivoto/kit`?
3. **Old `@ai/image` handler:** Delete it or keep as deprecated alias? (CLAUDE.md says no backward compat — delete it.)
4. **forEach parallelism:** Will image generation calls run in parallel or sequential within a forEach? Not this command's decision, but impacts UX and rate limiting.

---

## Next Steps

1. Create shared `ai/defaults.ts` with `AI_IMAGE_DEFAULTS`
2. Create `GenerateImageHandler` in `core-handlers/ai/image/`
3. Implement `{{variation}}` replaceAll substitution
4. Implement model tier resolution (reuse reverseImage pattern)
5. Register in `CoreHandlersBundle` as `@ai/image/generate`
6. Remove old `@ai/image` handler (ImageHandler) and its registration
7. Unit tests with mock provider
8. Integration test with real Gemini API
